<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 12px;
      color: #333;
      background: #fff;
      padding: 16px;
    }
    
    h1 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #1a1a1a;
    }
    
    h2 {
      font-size: 13px;
      font-weight: 600;
      margin: 16px 0 8px 0;
      color: #333;
    }
    
    .section {
      margin-bottom: 16px;
    }
    
    .button-group {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    
    button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    button.primary {
      background: #0d99ff;
      color: white;
    }
    
    button.primary:hover {
      background: #0077cc;
    }
    
    button.secondary {
      background: #f0f0f0;
      color: #333;
    }
    
    button.secondary:hover {
      background: #e0e0e0;
    }
    
    button.success {
      background: #1bc47d;
      color: white;
    }
    
    button.success:hover {
      background: #15a366;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .status {
      padding: 8px 12px;
      border-radius: 6px;
      margin-bottom: 12px;
      font-size: 11px;
    }
    
    .status.info {
      background: #e8f4fd;
      color: #0066cc;
    }
    
    .status.success {
      background: #e6f7ef;
      color: #0d7544;
    }
    
    .status.error {
      background: #fde8e8;
      color: #c41e3a;
    }
    
    .selection-info {
      font-size: 11px;
      color: #666;
      margin-bottom: 12px;
    }
    
    .output-area {
      width: 100%;
      height: 300px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 12px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 10px;
      resize: vertical;
      overflow: auto;
      background: #fafafa;
    }
    
    .tabs {
      display: flex;
      border-bottom: 1px solid #e0e0e0;
      margin-bottom: 12px;
    }
    
    .tab {
      padding: 8px 16px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 12px;
      color: #666;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
    }
    
    .tab.active {
      color: #0d99ff;
      border-bottom-color: #0d99ff;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .stat-card {
      background: #f8f8f8;
      padding: 12px;
      border-radius: 6px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: 600;
      color: #0d99ff;
    }
    
    .stat-label {
      font-size: 10px;
      color: #666;
      margin-top: 4px;
    }
    
    .server-config {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .server-config input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 12px;
    }
    
    .connection-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
    }
    
    .connection-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ccc;
    }
    
    .connection-dot.connected {
      background: #1bc47d;
    }
    
    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>
<body>
  <h1>ğŸ”„ Flow Extractor</h1>
  
  <div class="selection-info" id="selectionInfo">
    é¸æŠãªã— - ãƒšãƒ¼ã‚¸å…¨ä½“ã‚’æŠ½å‡ºã—ã¾ã™
  </div>
  
  <div class="button-group">
    <button class="primary" id="extractAll">ãƒšãƒ¼ã‚¸å…¨ä½“ã‚’æŠ½å‡º</button>
    <button class="secondary" id="extractSelection">é¸æŠç¯„å›²ã‚’æŠ½å‡º</button>
  </div>
  
  <div id="statusArea"></div>
  
  <div class="stats" id="stats" style="display: none;">
    <div class="stat-card">
      <div class="stat-value" id="screenCount">0</div>
      <div class="stat-label">ç”»é¢æ•°</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="interactionCount">0</div>
      <div class="stat-label">ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="connectionCount">0</div>
      <div class="stat-label">é·ç§»</div>
    </div>
  </div>
  
  <div class="tabs">
    <button class="tab active" data-tab="markdown">Markdown</button>
    <button class="tab" data-tab="json">JSON</button>
    <button class="tab" data-tab="mermaid">Mermaid</button>
  </div>
  
  <div class="tab-content active" id="markdown-tab">
    <pre class="output-area" id="markdownOutput">æŠ½å‡ºãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ãƒ­ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¦ãã ã•ã„</pre>
  </div>
  
  <div class="tab-content" id="json-tab">
    <pre class="output-area" id="jsonOutput"></pre>
  </div>
  
  <div class="tab-content" id="mermaid-tab">
    <pre class="output-area" id="mermaidOutput"></pre>
  </div>
  
  <h2>ğŸ–¥ï¸ MCPã‚µãƒ¼ãƒãƒ¼é€£æº</h2>
  
  <div class="server-config">
    <input type="text" id="serverUrl" value="http://localhost:3846" placeholder="ã‚µãƒ¼ãƒãƒ¼URL">
    <div class="connection-status">
      <div class="connection-dot" id="connectionDot"></div>
      <span id="connectionText">æœªæ¥ç¶š</span>
    </div>
  </div>
  
  <div class="button-group">
    <button class="success" id="sendToServer" disabled>ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡</button>
    <button class="secondary" id="copyToClipboard" disabled>ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼</button>
  </div>

  <script>
    let flowData = null;
    let markdownData = null;
    
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
      });
    });
    
    // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('extractAll').addEventListener('click', () => {
      showStatus('æŠ½å‡ºä¸­...', 'info');
      parent.postMessage({ pluginMessage: { type: 'extract-all' } }, '*');
    });
    
    document.getElementById('extractSelection').addEventListener('click', () => {
      showStatus('é¸æŠç¯„å›²ã‚’æŠ½å‡ºä¸­...', 'info');
      parent.postMessage({ pluginMessage: { type: 'extract-selection' } }, '*');
    });
    
    document.getElementById('sendToServer').addEventListener('click', async () => {
      if (!flowData) return;
      
      const serverUrl = document.getElementById('serverUrl').value;
      showStatus('ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ä¸­...', 'info');
      
      try {
        const response = await fetch(serverUrl + '/flow-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(flowData)
        });
        
        if (response.ok) {
          showStatus('ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡å®Œäº†!', 'success');
          document.getElementById('connectionDot').classList.add('connected');
          document.getElementById('connectionText').textContent = 'æ¥ç¶šæ¸ˆã¿';
        } else {
          throw new Error('Server returned ' + response.status);
        }
      } catch (error) {
        showStatus('é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        document.getElementById('connectionDot').classList.remove('connected');
        document.getElementById('connectionText').textContent = 'æœªæ¥ç¶š';
      }
    });
    
    document.getElementById('copyToClipboard').addEventListener('click', () => {
      const activeTab = document.querySelector('.tab.active').dataset.tab;
      let text = '';
      
      if (activeTab === 'markdown') {
        text = markdownData;
      } else if (activeTab === 'json') {
        text = JSON.stringify(flowData, null, 2);
      } else if (activeTab === 'mermaid') {
        text = generateMermaid(flowData);
      }
      
      navigator.clipboard.writeText(text).then(() => {
        showStatus('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ!', 'success');
      });
    });
    
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;
      
      switch (msg.type) {
        case 'flow-data':
          flowData = msg.data;
          markdownData = msg.markdown;
          updateUI();
          showStatus('æŠ½å‡ºå®Œäº†!', 'success');
          break;
          
        case 'selection-changed':
          if (msg.count === 0) {
            document.getElementById('selectionInfo').textContent = 'é¸æŠãªã— - ãƒšãƒ¼ã‚¸å…¨ä½“ã‚’æŠ½å‡ºã—ã¾ã™';
          } else {
            document.getElementById('selectionInfo').textContent = 
              `${msg.count}å€‹é¸æŠä¸­: ${msg.names.slice(0, 3).join(', ')}${msg.count > 3 ? '...' : ''}`;
          }
          break;
          
        case 'error':
          showStatus('ã‚¨ãƒ©ãƒ¼: ' + msg.message, 'error');
          break;
      }
    };
    
    function showStatus(message, type) {
      const statusArea = document.getElementById('statusArea');
      statusArea.innerHTML = `<div class="status ${type}">${message}</div>`;
    }
    
    function updateUI() {
      if (!flowData) return;
      
      // çµ±è¨ˆã‚’æ›´æ–°
      document.getElementById('stats').style.display = 'grid';
      document.getElementById('screenCount').textContent = flowData.screens.length;
      
      let interactionCount = 0;
      flowData.screens.forEach(s => interactionCount += s.interactions.length);
      document.getElementById('interactionCount').textContent = interactionCount;
      document.getElementById('connectionCount').textContent = flowData.flowConnections.length;
      
      // å‡ºåŠ›ã‚’æ›´æ–°
      document.getElementById('markdownOutput').textContent = markdownData;
      document.getElementById('jsonOutput').textContent = JSON.stringify(flowData, null, 2);
      document.getElementById('mermaidOutput').textContent = generateMermaid(flowData);
      
      // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
      document.getElementById('sendToServer').disabled = false;
      document.getElementById('copyToClipboard').disabled = false;
    }
    
    function generateMermaid(data) {
      if (!data || !data.flowConnections.length) {
        return 'flowchart TD\n  NoData[ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“]';
      }
      
      let mermaid = 'flowchart TD\n';
      
      // ãƒãƒ¼ãƒ‰IDã‚’Mermaidäº’æ›ã®å½¢å¼ã«å¤‰æ›
      const sanitizeId = (id) => id.replace(/[:-]/g, '_');
      
      // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒãƒ¼ãƒ‰ã‚’è¿½åŠ 
      const nodes = new Set();
      data.flowConnections.forEach(conn => {
        const fromId = sanitizeId(conn.fromNodeId);
        const toId = sanitizeId(conn.toNodeId);
        
        if (!nodes.has(fromId)) {
          mermaid += `  ${fromId}["${conn.fromNodeName}"]\n`;
          nodes.add(fromId);
        }
        if (!nodes.has(toId)) {
          mermaid += `  ${toId}["${conn.toNodeName}"]\n`;
          nodes.add(toId);
        }
      });
      
      mermaid += '\n';
      
      // æ¥ç¶šã‚’è¿½åŠ 
      data.flowConnections.forEach(conn => {
        const fromId = sanitizeId(conn.fromNodeId);
        const toId = sanitizeId(conn.toNodeId);
        const label = `${conn.trigger}`;
        mermaid += `  ${fromId} -->|${label}| ${toId}\n`;
      });
      
      return mermaid;
    }
  </script>
</body>
</html>
